{% extends "base.html" %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">{{ view.object|yesno:"Edit Cat, New Cat" }}</h1>
<form method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}

    {% for field in form %}
    {% if field.name == "bonded_cats" %}
    {% include "cats/widgets/bonded_cats_widget.html" %}
    {% else %}

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
            {{ field.label }}
        </label>

        {{ field }}

        {% for error in field.errors %}
        <p class="text-sm text-red-600 mt-1">{{ error }}</p>
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}

    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
        Save
    </button>
    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300"
        onclick="window.history.back()">
        Cancel
    </button>
</form>
<script>
    function bondedCatsComponent(catId, initialSelected) {
        return {
            query: "",
            results: [],
            selected: [],
            selectedIds: [],

            init() {
                if (initialSelected.length > 0) {
                    fetch(`/cats/get-by-ids/?` + new URLSearchParams(initialSelected.map(id => ['ids[]', id])))
                        .then(r => r.json())
                        .then(data => {
                            this.selected = data;
                            this.selectedIds = initialSelected;
                        });
                }
            },

            search() {
                if (this.query.length < 2) {
                    this.results = [];
                    return;
                }

                fetch(`/cats/search/?q=${this.query}`)
                    .then(r => r.json())
                    .then(data => {
                        // Exclude already selected
                        this.results = data.filter(c => !this.selectedIds.includes(c.id));
                    });
            },

            add(cat) {
                // Prevent selecting the cat itself
                if (cat.id === catId) {
                    return;
                }

                this.selected.push(cat);
                this.selectedIds.push(cat.id);
                this.results = [];
                this.query = "";
            },

            remove(id) {
                this.selected = this.selected.filter(c => c.id !== id);
                this.selectedIds = this.selectedIds.filter(x => x !== id);
            }
        }
    }
</script>

{% endblock %}