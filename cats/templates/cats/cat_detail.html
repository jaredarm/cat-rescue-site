{% extends "base.html" %}

{% block title %}{{ cat.name }}{% endblock %}

{% block content %}

<script>
    function lightbox({ images }) {
        return {
            images,
            index: 0,
            show: false,
            startX: null,

            open(i) {
                this.index = i;
                this.show = true;
                document.body.classList.add('overflow-hidden');
            },
            close() {
                this.show = false;
                document.body.classList.remove('overflow-hidden');
            },
            next() {
                this.index = (this.index + 1) % this.images.length;
            },
            prev() {
                this.index = (this.index - 1 + this.images.length) % this.images.length;
            },

            touchStart(e) {
                this.startX = e.touches[0].clientX;
            },
            touchEnd(e) {
                let endX = e.changedTouches[0].clientX;
                let diff = endX - this.startX;
                if (Math.abs(diff) > 50) diff < 0 ? this.next() : this.prev();
            },

            init() {
                window.addEventListener('keydown', (e) => {
                    if (!this.show) return;
                    if (e.key === 'ArrowRight') this.next();
                    if (e.key === 'ArrowLeft') this.prev();
                    if (e.key === 'Escape') this.close();
                });
            }
        }
    }
</script>

<div class="bg-white shadow rounded-lg p-6">
    <!-- Back button -->
    <a href="/cats/" class="bg-cyan-600 text-white px-4 py-1 rounded-full hover:bg-purple-700 text-sm">
        <i class="fa-solid fa-angle-left"></i> Back
    </a>

    <!-- Edit Cat (if authenticated) -->
    {% if user.is_authenticated %}
    <a href="{% url 'cat_edit' cat.pk %}"
        class="ml-2 mt-4 px-4 py-1 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 text-sm">
        <i class="fa-solid fa-pen-to-square"></i> Edit
    </a>
    {% endif %}

    <!-- Name -->
    <h2 class="mt-4 w-full text-left text-xl font-semibold text-purple-700">
        {{ cat.name }}
    </h2>
    <h3 class="w-full text-base font-semibold text-purple-900">
        {{ cat.tagline }}
    </h3>

    <!-- Lightbox -->
    <div x-data="lightbox({ images: [
            {% for img in cat.images.all %}
                { url: '{{ img.image.url }}', alt: '{{ img.alt_text|default:"" }}' },
            {% endfor %}
        ] })">

        <!-- Photo grid -->
        <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {% for img in cat.images.all %}
            <div class="overflow-hidden">
                <img class="h-full w-full object-cover rounded-lg shadow-lg cursor-pointer " src="{{ img.image.url }}"
                    @click="open({{ forloop.counter0 }})" alt="{{ img.alt_text }}">
            </div>
            {% endfor %}
        </div>
        <!-- Lightbox -->
        <div x-show="show" x-transition.opacity
            class="fixed top-0 inset-0 bg-black/90 flex justify-center items-center pt-2 z-40" @click.self="close"
            @touchstart="touchStart" @touchend="touchEnd">

            <!-- Lightbox image -->
            <img :src="images[index].url" :alt="images[index].alt" class="max-h-[80vh] max-w-[90vw] rounded-lg" />

            <!-- Close button -->
            <button
                class="absolute top-3 right-0 z-50 flex h-16 p-4 w-1/12 cursor-pointer items-start justify-end text-3xl text-white"
                @click="close"><i class="fa-solid fa-xmark"></i></button>

            <!-- Left button -->
            <button
                class="absolute top-1/2 left-0 z-40 h-[80%] w-1/6 -translate-y-1/2  pl-4 text-left text-4xl text-white"
                @click.stop="prev"><i class="fa-solid fa-angle-left"></i></button>

            <!-- Right button -->
            <button
                class="absolute top-1/2 right-0 z-40 h-[80%] w-1/6 -translate-y-1/2 pr-4 text-right text-4xl text-white"
                @click.stop="next"><i class="fa-solid fa-angle-right"></i></button>
        </div>
    </div>

    <div class="grid md:grid-cols-2 mt-4 md:justify-center text-left">
        <p><strong>Breed:</strong> {{ cat.breed }}</p>
        <p><strong>Age:</strong> {{ cat.age }}</p>
        <p><strong>Colour:</strong> {{ cat.colour }}</p>
        <p><strong>Sex:</strong> {{ cat.get_sex_display }}</p>
        <p><strong>Status:</strong> {{ cat.get_status_display }}</p>
        <p><strong>Fostered In:</strong> {{ cat.fostered_in }}</p>
    </div>

    <!-- Main Description -->
    <div class="mt-4">
        <h2 class="text-xl font-semibold mb-2">Description</h2>
        <p>{{ cat.description|linebreaks }}</p>
    </div>

    <!-- Health and compatibility -->
    <div class="mt-4 space-y-2 grid-cols-2">
        <!-- Vaccinated -->
        <div class="flex items-start gap-3">
            <span class="text-xl">
                {% if cat.is_vaccinated %}✓{% else %}✗{% endif %}
            </span>
            <div>
                <strong>Vaccinated</strong>
                {% if cat.vaccinated_notes %}
                <p class="text-gray-600 text-sm">{{ cat.vaccinated_notes }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Microchipped -->
        <div class="flex items-start gap-3">
            <span class="text-xl">
                {% if cat.is_microchipped %}✓{% else %}✗{% endif %}
            </span>
            <div>
                <strong>Microchipped</strong>
            </div>
        </div>

        <!-- Sterilised -->
        <div class="flex items-start gap-3">
            <span class="text-xl">
                {% if cat.is_sterilised %}✓{% else %}✗{% endif %}
            </span>
            <div>
                <strong>Sterilised</strong>
            </div>
        </div>

        <!-- FIV -->
        <div class="flex items-start gap-3">
            <span class="text-xl">
                {% if cat.is_fiv_positive %}✓{% else %}✗{% endif %}
            </span>
            <div>
                <strong>FIV Status</strong>
                {% if cat.health_notes %}
                <p class="text-gray-600 text-sm">{{ cat.health_notes }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Good with kids -->
        <div class="flex items-start gap-3">
            <span class="text-xl">
                {% if cat.is_good_with_kids %}✓{% else %}✗{% endif %}
            </span>
            <div>
                <strong>Good with kids</strong>
                {% if cat.good_with_kids_notes %}
                <p class="text-gray-600 text-sm">{{ cat.good_with_kids_notes }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Good with dogs -->
        <div class="flex items-start gap-3">
            <span class="text-xl">
                {% if cat.is_good_with_dogs %}✓{% else %}✗{% endif %}
            </span>
            <div>
                <strong>Good with dogs</strong>
                {% if cat.good_with_dogs_notes %}
                <p class="text-gray-600 text-sm">{{ cat.good_with_dogs_notes }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Good with cats -->
        <div class="flex items-start gap-3">
            <span class="text-xl">
                {% if cat.is_good_with_cats %}✓{% else %}✗{% endif %}
            </span>
            <div>
                <strong>Good with cats</strong>
                {% if cat.good_with_cats_notes %}
                <p class="text-gray-600 text-sm">{{ cat.good_with_cats_notes }}</p>
                {% endif %}
            </div>
        </div>
        <!-- END: Health and compatibility -->
    </div>
</div>
{% endblock %}