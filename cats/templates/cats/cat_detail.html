{% extends "base.html" %}

{% block title %}9 Lives Cat Rescue - {{ cat.name }}{% endblock %}

{% block admin_panel %}
<a href="{% url 'cat_edit' cat.pk %}" class="px-4 py-1 bg-yellow-500 text-sm rounded-full">
    <i class="fa-solid fa-pen-to-square mr-2"></i>Edit Cat</a>
<a href="{% url 'manage_cat_photos' cat.pk %}" class="px-4 py-1 bg-blue-500 text-sm rounded-full">
    <i class="fa-regular fa-images mr-2"></i>Manage Photos</a>
{% endblock %}

{% block content %}

<script>
    function lightbox({ images }) {
        return {
            images,
            index: 0,
            show: false,
            startX: null,

            open(i) {
                this.index = i;
                this.show = true;
                document.body.classList.add('overflow-hidden');
            },
            close() {
                this.show = false;
                document.body.classList.remove('overflow-hidden');
            },
            next() {
                this.index = (this.index + 1) % this.images.length;
            },
            prev() {
                this.index = (this.index - 1 + this.images.length) % this.images.length;
            },

            touchStart(e) {
                this.startX = e.touches[0].clientX;
            },
            touchEnd(e) {
                let endX = e.changedTouches[0].clientX;
                let diff = endX - this.startX;
                if (Math.abs(diff) > 50) diff < 0 ? this.next() : this.prev();
            },

            init() {
                window.addEventListener('keydown', (e) => {
                    if (!this.show) return;
                    if (e.key === 'ArrowRight') this.next();
                    if (e.key === 'ArrowLeft') this.prev();
                    if (e.key === 'Escape') this.close();
                });
            }
        }
    }
</script>

<div class="page-container">
    <!-- Navigation -->
    <div class="mb-6 flex items-center justify-between border-b dark:border-gray-700 pb-4">
        <a href="/cats/" class="inline-flex items-center gap-2 text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 font-medium transition">
            <i class="fa-solid fa-arrow-left"></i>
            <span>Back to Cats</span>
        </a>
    </div>

    <!-- Name and Tagline Section -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-purple-700 dark:text-purple-300 mb-2">
            {% if cat.bonded_cats.exists %}
            <span>
                {{ cat.name }}
                {% for partner in cat.bonded_cats.all %}
                <i class="text-red-500 fa-solid fa-heart mx-1"></i>
                <a href="{% url 'cat_detail' partner.pk %}" class="text-purple-700 font-bold hover:underline">{{ partner.name }}</a>
                <span class="text-red-500 text-sm">(Bonded)</span>
                {% endfor %}
            </span>
            {% else %}
            <span>{{ cat.name }}</span>
            {% endif %}
        </h2>
        {% if cat.is_special_needs %}
        <div class="inline-block bg-red-100 dark:bg-red-900 border border-red-300 dark:border-red-700 text-red-800 dark:text-red-200 px-3 py-1 rounded-full text-sm font-medium mb-2">
            <i class="fa-solid fa-triangle-exclamation mr-2"></i>Special Needs
        </div>
        {% endif %}
        <h3 class="text-lg text-gray-600 dark:text-gray-400 italic">{{ cat.tagline }}</h3>
    </div>

    <!-- Lightbox -->
    <div x-data="lightbox({ images: [
            {% for img in cat.images.all %}
                { url: '{{ img.image.url }}', alt: '{{ img.alt_text|default:"" }}' },
            {% endfor %}
        ] })">

        <!-- Photo grid -->
        <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
            {% for img in cat.images.all %}
            <div class="overflow-hidden rounded-lg shadow-md hover:shadow-lg transition">
                <img class="h-full w-full object-cover cursor-pointer" src="{{ img.image.url }}"
                    @click="open({{ forloop.counter0 }})" alt="{{ img.alt_text }}">
            </div>
            {% endfor %}
        </div>
        <!-- Lightbox -->
        <div x-show="show" x-transition.opacity
            class="fixed top-0 inset-0 bg-black/90 flex justify-center items-center pt-2 z-40" @click.self="close"
            @touchstart="touchStart" @touchend="touchEnd">

            <!-- Lightbox image -->
            <img :src="images[index].url" :alt="images[index].alt" class="max-h-[80vh] max-w-[90vw] rounded-lg" />

            <!-- Close button -->
            <button
                class="absolute top-3 right-0 z-50 flex h-16 p-4 w-1/12 cursor-pointer items-start justify-end text-3xl text-white"
                @click="close"><i class="fa-solid fa-xmark"></i></button>

            <!-- Left button -->
            <button
                class="absolute top-1/2 left-0 z-40 h-[80%] w-1/6 -translate-y-1/2  pl-4 text-left text-4xl text-white"
                @click.stop="prev"><i class="fa-solid fa-angle-left"></i></button>

            <!-- Right button -->
            <button
                class="absolute top-1/2 right-0 z-40 h-[80%] w-1/6 -translate-y-1/2 pr-4 text-right text-4xl text-white"
                @click.stop="next"><i class="fa-solid fa-angle-right"></i></button>
        </div>
    </div>

    <!-- Basic Information Card -->
    <div class="mb-6 grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="card-info">
            <p class="text-muted">Breed</p>
            <p class="text-lg font-semibold text-purple-700 dark:text-purple-300">{{ cat.breed|default:"Not specified" }}</p>
        </div>
        <div class="card-info">
            <p class="text-muted">Age</p>
            <p class="text-lg font-semibold text-purple-700 dark:text-purple-300">{{ cat.age }}</p>
        </div>
        <div class="card-info">
            <p class="text-muted">Colour</p>
            <p class="text-lg font-semibold text-purple-700 dark:text-purple-300">{{ cat.colour|default:"Not specified" }}</p>
        </div>
        <div class="card-info">
            <p class="text-muted">Sex</p>
            <p class="text-lg font-semibold text-purple-700 dark:text-purple-300">{{ cat.get_sex_display }}</p>
        </div>
        <div class="card-info">
            <p class="text-muted">Status</p>
            <p class="text-lg font-semibold text-purple-700 dark:text-purple-300">{{ cat.get_status_display }}</p>
        </div>
        <div class="card-info">
            <p class="text-muted">Fostered In</p>
            <p class="text-lg font-semibold text-purple-700 dark:text-purple-300">{{ cat.fostered_in|default:"Not specified" }}</p>
        </div>
    </div>

    <!-- Main Description -->
    <div class="mb-6 description-box">
        <h2 class="heading-subsection">About {{ cat.name }}</h2>
        <p class="text-gray-700 dark:text-gray-300 leading-relaxed">{{ cat.description|linebreaks }}</p>
    </div>

    <!-- Health and Compatibility Section -->
    <div class="mb-6">
        <h2 class="heading-section">Health & Compatibility</h2>
        <div class="grid md:grid-cols-2 gap-4">
            <!-- Vaccinated -->
            {% if cat.is_vaccinated or cat.vaccinated_notes %}
            <div class="card-health-positive">
                <div class="flex {% if not cat.vaccinated_notes %}items-center{% else %}items-start{% endif %} gap-3">
                    <span class="icon-check-positive">
                        {% if cat.is_vaccinated %}<i class="fa-solid fa-check"></i>{% else %}<i class="fa-solid fa-info"></i>{% endif %}
                    </span>
                    <div>
                        <p class="text-health-positive">Vaccinated</p>
                        {% if cat.vaccinated_notes %}
                        <p class="text-secondary">{{ cat.vaccinated_notes }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Microchipped -->
            {% if cat.is_microchipped %}
            <div class="card-health-positive">
                <div class="flex items-center gap-3">
                    <span class="icon-check-positive icon-flex-shrink"><i class="fa-solid fa-check"></i></span>
                    <div>
                        <p class="text-health-positive m-0">Microchipped</p>
                        {% if cat.microchip_number %}
                        <p class="text-secondary">{{ cat.microchip_number }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Sterilised -->
            {% if cat.is_sterilised %}
            <div class="card-health-positive">
                <div class="flex items-center gap-3">
                    <span class="icon-check-positive icon-flex-shrink"><i class="fa-solid fa-check"></i></span>
                    <div>
                        <p class="text-health-positive m-0">Sterilised</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- FIV Status -->
            {% if cat.is_fiv_positive or cat.health_notes %}
            <div class="{% if cat.is_fiv_positive %}card-health-critical{% else %}card-health-positive{% endif %}">
                <div class="flex {% if not cat.health_notes %}items-center{% else %}items-start{% endif %} gap-3">
                    <span class="{% if cat.is_fiv_positive %}icon-check-critical{% else %}icon-check-positive{% endif %}">
                        {% if cat.is_fiv_positive %}<i class="fa-solid fa-circle-exclamation"></i>{% else %}<i class="fa-solid fa-check"></i>{% endif %}
                    </span>
                    <div>
                        <p class="{% if cat.is_fiv_positive %}text-health-critical{% else %}text-health-positive{% endif %}">FIV Status</p>
                        {% if cat.health_notes %}
                        <p class="text-secondary">{{ cat.health_notes }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Compatibility Section -->
    <div class="mb-6">
        <h2 class="heading-section">Compatibility</h2>
        <div class="grid md:grid-cols-2 gap-4">
            <!-- Good with Kids -->
            {% if cat.is_good_with_kids or cat.good_with_kids_notes %}
            <div class="{% if cat.is_good_with_kids %}card-health-positive{% else %}card-health-warning{% endif %}">
                <div class="flex {% if not cat.good_with_kids_notes %}items-center{% else %}items-start{% endif %} gap-3">
                    <span class="{% if cat.is_good_with_kids %}icon-check-positive{% else %}icon-check-warning{% endif %}">
                        {% if cat.is_good_with_kids %}<i class="fa-solid fa-check"></i>{% else %}<i class="fa-solid fa-circle-info"></i>{% endif %}
                    </span>
                    <div>
                        <p class="{% if cat.is_good_with_kids %}text-health-positive{% else %}text-health-warning{% endif %}">Good with Kids</p>
                        {% if cat.good_with_kids_notes %}
                        <p class="text-secondary">{{ cat.good_with_kids_notes }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Good with Dogs -->
            {% if cat.is_good_with_dogs or cat.good_with_dogs_notes %}
            <div class="{% if cat.is_good_with_dogs %}card-health-positive{% else %}card-health-warning{% endif %}">
                <div class="flex {% if not cat.good_with_dogs_notes %}items-center{% else %}items-start{% endif %} gap-3">
                    <span class="{% if cat.is_good_with_dogs %}icon-check-positive{% else %}icon-check-warning{% endif %}">
                        {% if cat.is_good_with_dogs %}<i class="fa-solid fa-check"></i>{% else %}<i class="fa-solid fa-circle-info"></i>{% endif %}
                    </span>
                    <div>
                        <p class="{% if cat.is_good_with_dogs %}text-health-positive{% else %}text-health-warning{% endif %}">Good with Dogs</p>
                        {% if cat.good_with_dogs_notes %}
                        <p class="text-secondary">{{ cat.good_with_dogs_notes }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Good with Cats -->
            {% if cat.is_good_with_cats or cat.good_with_cats_notes %}
            <div class="{% if cat.is_good_with_cats %}card-health-positive{% else %}card-health-warning{% endif %}">
                <div class="flex {% if not cat.good_with_cats_notes %}items-center{% else %}items-start{% endif %} gap-3">
                    <span class="{% if cat.is_good_with_cats %}icon-check-positive{% else %}icon-check-warning{% endif %}">
                        {% if cat.is_good_with_cats %}<i class="fa-solid fa-check"></i>{% else %}<i class="fa-solid fa-circle-info"></i>{% endif %}
                    </span>
                    <div>
                        <p class="{% if cat.is_good_with_cats %}text-health-positive{% else %}text-health-warning{% endif %}">Good with Cats</p>
                        {% if cat.good_with_cats_notes %}
                        <p class="text-secondary">{{ cat.good_with_cats_notes }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Apply Now Button -->
    <div class="flex justify-center mt-8">
        <a href="{% url 'application_add' %}?cats={{ cat.id }}{% for partner in cat.bonded_cats.all %}&cats={{ partner.id }}{% endfor %}"
            class="btn-apply">
            <i class="fa-solid fa-heart mr-2"></i>Apply to Adopt
        </a>
    </div>
</div>
{% endblock %}