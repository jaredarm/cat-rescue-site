<div 
    x-data="catsSelectionComponent([{% for cat in selected_cat_ids %}{% if cat.id %}{{ cat.id }}{% else %}{{ cat }}{% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}])"
>

    <label class="form-label mb-2">
        Cats to Adopt
    </label>

    <!-- Pills (group bonded cats into a single pill) -->
    <div class="flex flex-wrap gap-2 mb-3">
        <template x-for="group in groups()" :key="group[0].id">
            <span class="px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 rounded-full flex items-center gap-3">
                <template x-for="(c, idx) in group" :key="c.id">
                    <span class="flex items-center gap-2">
                        <img x-bind:src="c.primary_image || ''" alt="" class="h-6 w-6 rounded-full object-cover border border-white dark:border-blue-800" />
                        <span x-text="c.name"></span>
                        <span x-show="idx < group.length - 1" class="text-red-500"><i class="fa-solid fa-heart"></i></span>
                    </span>
                </template>

                <button type="button" @click="removeGroup(group.map(c => c.id))" class="ml-2 text-blue-700 hover:text-blue-900 dark:text-blue-200 dark:hover:text-blue-100">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </span>
        </template>
    </div>

    <!-- Search box -->
    <input 
        type="text"
        placeholder="Search cats..."
        class="border border-gray-300 dark:border-gray-600 rounded p-2 w-full mb-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"
        x-model="query"
        @input.debounce.300ms="search()"
    >

    <!-- Search results -->
    <div class="border border-gray-200 dark:border-gray-700 rounded bg-white dark:bg-gray-800 shadow max-h-48 overflow-y-auto" x-show="results.length > 0">
        <template x-for="cat in results" :key="cat.id">
            <div 
                class="flex items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm text-gray-900 dark:text-gray-100"
                @click="add(cat)"
            >
                <img x-bind:src="cat.primary_image || ''" alt="" class="h-10 w-10 rounded object-cover mr-3" />
                <div class="flex-1">
                    <div class="font-medium" x-text="cat.name"></div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <span x-text="cat.age"></span>
                        <span x-show="cat.fostered_in"> — <span x-text="cat.fostered_in"></span></span>
                        <span x-show="cat.status !== 'available'"> — <span x-text="cat.status"></span></span>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Hidden inputs Django reads -->
    <template x-for="id in selectedIds" :key="id">
        <input type="hidden" name="cats" :value="id">
    </template>
</div>
